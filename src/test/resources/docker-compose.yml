services:
  mysqldb_load:
    image: mysql:8.0.30
    restart: unless-stopped
    env_file: ./.env
    # windows host fix
    command: >
      bash -c "
      chmod 644 /etc/my.cnf
      && /entrypoint.sh mysqld
      "
    environment:
      - MYSQL_ROOT_PASSWORD=$MYSQLDB_LOAD_ROOT_PASSWORD
      - MYSQL_DATABASE=$MYSQLDB_LOAD_DATABASE
    ports:
      - $MYSQLDB_LOAD_LOCAL_PORT:$MYSQLDB_LOAD_DOCKER_PORT
    volumes:
      - db:/var/lib/mysql
      - ./db/my.cnf:/etc/my.cnf
  app:
    depends_on:
      - mysqldb_load
    build: ./
    restart: on-failure
    env_file: ./.env
    ports:
      - $SPRING_LOCAL_PORT:$SPRING_DOCKER_PORT
      - $JAVA_DEBUG_PORT:$JAVA_DEBUG_PORT
    environment:
      SPRING_APPLICATION_JSON: '{
        "spring.datasource.url"  : "jdbc:mysql://mysqldb:$MYSQLDB_DOCKER_PORT/$MYSQLDB_DATABASE?useSSL=false&createDatabaseIfNotExist=true",
        "spring.datasource.username" : "$MYSQLDB_USER",
        "spring.datasource.password" : "$MYSQLDB_ROOT_PASSWORD"
      }'
    stdin_open: true
    tty: true
  # restore db with 1'000'000 users for load testing IF the db is empty (users == 0)
  sql_init:
    depends_on:
      - app
      - mysqldb_load
    command:
      - >
        bash -c "
        chmod 644 /etc/my.cnf
        && USERCOUNT=$(mysql -uroot -proot -D highload_social -B --disable-column-names -e 'select count(*) from users;')
        && if (($USERCOUNT == 0)); then gunzip /tmp/mysql.gz && mysql -h mysqldb:$MYSQLDB_LOAD_DOCKER_PORT -D $MYSQLDB_LOAD_DATABASE -u root -p $MYSQLDB_LOAD_ROOT_PASSWORD < /tmp/mysql ; fi
        "
    restart: no
    volumes:
      - db:/var/lib/mysql
      - ./db/my.cnf:/etc/my.cnf
      - ./src/test/generated/mysql.gz:/tmp/mysql.gz

volumes:
  db: